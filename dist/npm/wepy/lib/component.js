"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function getEventsFn(t,i){var e=t.events?t.events[i]:void 0,n=void 0===e?"undefined":_typeof(e),o=void 0;if("string"===n){var a=t.methods&&t.methods[e];"function"==typeof a&&(o=a)}else"function"===n&&(o=e);return o}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,i){for(var e=0;e<i.length;e++){var n=i[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(i,e,n){return e&&t(i.prototype,e),n&&t(i,n),i}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_event=require("./event.js"),_event2=_interopRequireDefault(_event),_util=require("./util.js"),_util2=_interopRequireDefault(_util),Props={check:function(t,i){switch(t){case String:return"string"==typeof i;case Number:return"number"==typeof i;case Boolean:return"boolean"==typeof i;case Function:return"function"==typeof i;case Object:return"object"===(void 0===i?"undefined":_typeof(i));case Array:return"[object Array]"===toString.call(i);default:return i instanceof t}},build:function(t){var i={};return"string"==typeof t?i[t]={}:"[object Array]"===toString.call(t)?t.forEach(function(t){i[t]={}}):Object.keys(t).forEach(function(e){"function"==typeof t[e]?i[e]={type:[t[e]]}:"[object Array]"===toString.call(t[e])?i[e]={type:t[e]}:i[e]=t[e],i[e].type&&"[object Array]"!==toString.call(i[e].type)&&(i[e].type=[i[e].type])}),i},valid:function(t,i,e){var n=this,o=!1;if(t[i]){if(t[i].type)return t[i].type.some(function(t){return n.check(t,e)});o=!0}return o},getValue:function(t,i,e){var n;return n=void 0!==e&&this.valid(t,i,e)?e:"function"==typeof t[i].default?t[i].default():t[i].default,t[i].coerce?t[i].coerce(n):n}},_class=function(){function t(){_classCallCheck(this,t),this.$com={},this.$mixins=[],this.$isComponent=!0,this.$prefix="",this.$mappingProps={},this.data={},this.methods={}}return _createClass(t,[{key:"$init",value:function(t,i,e){var n=this;this.$wxpage=t,this.$isComponent&&(this.$root=i||this.$root,this.$parent=e||this.$parent,this.$wxapp=this.$root.$parent.$wxapp),this.props&&(this.props=Props.build(this.props));var o=void 0,a={},s=this.props,r=void 0,p=void 0,h=void 0,f=!1,u=void 0;if(void 0===this.$initData?this.$initData=_util2.default.$copy(this.data,!0):this.data=_util2.default.$copy(this.$initData,!0),this.$props)for(r in this.$props)for(h in this.$props[r])/\.sync$/.test(h)&&(this.$mappingProps[this.$props[r][h]]||(this.$mappingProps[this.$props[r][h]]={}),this.$mappingProps[this.$props[r][h]][r]=h.substring(7,h.length-5));if(s)for(r in s)p=void 0,e&&e.$props&&e.$props[this.$name]&&(p=e.$props[this.$name][r],(h=e.$props[this.$name]["v-bind:"+r+".once"]||e.$props[this.$name]["v-bind:"+r+".sync"])&&("object"===(void 0===h?"undefined":_typeof(h))?function(){s[r].repeat=h.for,f=!0;var t=h.for,i=e;t.split(".").forEach(function(t){i=i[t]}),u=Object.keys(i)[0],n.$mappingProps[r]||(n.$mappingProps[r]={}),n.$mappingProps[r].parent={mapping:h.for,from:r}}():(p=e[h],s[r].twoWay&&(this.$mappingProps[r]||(this.$mappingProps[r]={}),this.$mappingProps[r].parent=h)))),this.data[r]||s[r].repeat||(p=Props.getValue(s,r,p),this.data[r]=p);for(o in this.data)a[""+this.$prefix+o]=this.data[o],this[o]=this.data[o];if(this.$data=_util2.default.$copy(this.data,!0),f&&this.$setIndex(u),this.computed)for(o in this.computed){var c=this.computed[o];a[""+this.$prefix+o]=c.call(this),this[o]=_util2.default.$copy(a[""+this.$prefix+o],!0)}this.setData(a);var $=Object.getOwnPropertyNames(this.$com);$.length&&$.forEach(function(t){n.$com[t].$init(n.getWxPage(),i,n),n.$com[t].onLoad&&n.$com[t].onLoad(),n.$com[t].$mixins.forEach(function(i){i.onLoad&&i.onLoad.call(n.$com[t])}),n.$com[t].$apply()})}},{key:"$initMixins",value:function(){var t=this;this.mixins?"function"==typeof this.mixins&&(this.mixins=[this.mixins]):this.mixins=[],this.mixins.forEach(function(i){var e=new i;e.$init(t),t.$mixins.push(e)})}},{key:"onLoad",value:function(){}},{key:"setData",value:function(t,i){if("string"==typeof t){if(i){var e={};e[t]=i,t=e}else{var n={};n[t]=this.data[""+t],t=n}return this.$wxpage.setData(t)}var o=null,a=new RegExp("^"+this.$prefix.replace(/\$/g,"\\$"),"ig");for(o in t){var s=o.replace(a,"");this.$data[s]=_util2.default.$copy(t[o],!0)}return this.$wxpage.setData(t)}},{key:"getWxPage",value:function(){return this.$wxpage}},{key:"getCurrentPages",value:function(){return this.$wxpage.getCurrentPages()}},{key:"$setIndex",value:function(t){var i=this;if(this.$index!==t){this.$index=t;var e=this.props,n=this.$parent,o=void 0,a=void 0,s=void 0;if(e){for(o in e)a=void 0,n&&n.$props&&n.$props[this.$name]&&(a=n.$props[this.$name][o],(s=n.$props[this.$name]["v-bind:"+o+".once"]||n.$props[this.$name]["v-bind:"+o+".sync"])&&"object"===(void 0===s?"undefined":_typeof(s))&&function(){var e=s.for,r=n;e.split(".").forEach(function(t){r=r[t]}),a=r[t],i.$index=t,i.data[o]=a,i[o]=a,i.$data[o]=_util2.default.$copy(i[o],!0)}());for(o in this.$com)this.$com[o].$index=void 0}}}},{key:"$getComponent",value:function(t){var i=this;if("string"==typeof t){if(-1===t.indexOf("/"))return this.$com[t];if("/"===t)return this.$parent;t.split("/").forEach(function(e,n){0===n?t=""===e?i.$root:"."===e?i:".."===e?i.$parent:i.$getComponent(e):e&&(t=t.$com[e])})}return"object"!==(void 0===t?"undefined":_typeof(t))?null:t}},{key:"$invoke",value:function(t,i){if(!(t=this.$getComponent(t)))throw new Error("Invalid path: "+t);for(var e=t.methods?t.methods[i]:"",n=arguments.length,o=Array(n>2?n-2:0),a=2;a<n;a++)o[a-2]=arguments[a];if("function"==typeof e){var s=new _event2.default("",this,"invoke"),r=e.apply(t,o.concat(s));return t.$apply(),r}if("function"==typeof(e=t[i]))return e.apply(t,o);throw new Error("Invalid method: "+i)}},{key:"$broadcast",value:function(t){for(var i=arguments.length,e=Array(i>1?i-1:0),n=1;n<i;n++)e[n-1]=arguments[n];for(var o=this,a="string"==typeof t?new _event2.default(t,this,"broadcast"):a,s=[o];s.length&&a.active;){var r=s.shift();for(var p in r.$com){if("break"===function(i){i=r.$com[i],s.push(i);var n=getEventsFn(i,t);if(n&&i.$apply(function(){n.apply(i,e.concat(a))}),!a.active)return"break";p=i}(p))break}}}},{key:"$emit",value:function(t){for(var i=this,e=arguments.length,n=Array(e>1?e-1:0),o=1;o<e;o++)n[o-1]=arguments[o];var a=this,s=this,r=new _event2.default(t,s,"emit");if(this.$parent.$events&&this.$parent.$events[this.$name]){var p=this.$parent.$events[this.$name]["v-on:"+t];if(p&&this.$parent.methods){var h=this.$parent.methods[p];if("function"==typeof h)return void this.$parent.$apply(function(){h.apply(i.$parent,n.concat(r))});throw new Error("Invalid method from emit, component is "+this.$parent.$name+", method is "+p+". Make sure you defined it already.\n")}}for(;a&&void 0!==a.$isComponent&&r.active;)!function(){var i=a,e=getEventsFn(i,t);e&&i.$apply(function(){e.apply(i,n.concat(r))}),a=i.$parent}()}},{key:"$apply",value:function(t){"function"==typeof t?(t.call(this),this.$apply()):this.$$phase?this.$$phase="$apply":this.$digest()}},{key:"$digest",value:function(){var t=this,i=void 0,e=this.$data;for(this.$$phase="$digest";this.$$phase;){var n={};for(i in e)_util2.default.$isEqual(this[i],e[i])||(this.watch&&this.watch[i]&&("function"==typeof this.watch[i]?this.watch[i].call(this,this[i],e[i]):"string"==typeof this.watch[i]&&"function"==typeof this.methods[i]&&this.methods[i].call(this,this[i],e[i])),n[this.$prefix+i]=this[i],this.data[i]=this[i],e[i]=_util2.default.$copy(this[i],!0),this.$mappingProps[i]&&Object.keys(this.$mappingProps[i]).forEach(function(e){var n=t.$mappingProps[i][e];"object"===(void 0===n?"undefined":_typeof(n))?t.$parent.$apply():"parent"!==e||_util2.default.$isEqual(t.$parent.$data[n],t[i])?"parent"===e||_util2.default.$isEqual(t.$com[e].$data[n],t[i])||(t.$com[e][n]=t[i],t.$com[e].data[n]=t[i],t.$com[e].$apply()):(t.$parent[n]=t[i],t.$parent.data[n]=t[i],t.$parent.$apply())}));if(Object.keys(n).length){if(this.computed)for(i in this.computed){var o=this.computed[i],a=o.call(this);_util2.default.$isEqual(this[i],a)||(n[this.$prefix+i]=a,this[i]=_util2.default.$copy(a,!0))}this.setData(n)}this.$$phase="$apply"===this.$$phase&&"$digest"}}}]),t}();exports.default=_class;