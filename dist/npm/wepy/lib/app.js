"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),_native=require("./native.js"),_native2=_interopRequireDefault(_native),RequestMQ={map:{},mq:[],running:[],MAX_REQUEST:5,push:function(e){for(e.t=+new Date;this.mq.indexOf(e.t)>-1||this.running.indexOf(e.t)>-1;)e.t+=10*Math.random()>>0;this.mq.push(e.t),this.map[e.t]=e},next:function(){var e=this;if(0!==this.mq.length&&this.running.length<this.MAX_REQUEST-1){var t=this.mq.shift(),n=this.map[t],i=n.complete;return n.complete=function(){for(var t=arguments.length,r=Array(t),s=0;s<t;s++)r[s]=arguments[s];e.running.splice(e.running.indexOf(n.t),1),delete e.map[n.t],i&&i.apply(n,r),e.next()},this.running.push(n.t),wx.request(n)}},request:function(e){return e=e||{},e="string"==typeof e?{url:e}:e,this.push(e),this.next()}},_class=function(){function e(){_classCallCheck(this,e),this.$addons={},this.$interceptors={},this.$pages={}}return _createClass(e,[{key:"$init",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.$initAPI(e,t.promisifyAPI),this.$wxapp=getApp()}},{key:"use",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];"string"==typeof e&&this[e]?(this.$addons[e]=1,this[e](n)):this.$addons[e.name]=new e(n)}},{key:"intercept",value:function(e,t){this.$interceptors[e]=t}},{key:"promisify",value:function(){}},{key:"requestfix",value:function(){}},{key:"$initAPI",value:function(e,t){var n=this,i={stopRecord:!0,pauseVoice:!0,stopVoice:!0,pauseBackgroundAudio:!0,stopBackgroundAudio:!0,showNavigationBarLoading:!0,hideNavigationBarLoading:!0,createAnimation:!0,createContext:!0,createCanvasContext:!0,hideKeyboard:!0,stopPullDownRefresh:!0};if(t)for(var r in t)i[r]=t[r];Object.keys(wx).forEach(function(t){i[t]||"on"===t.substr(0,2)||/\w+Sync$/.test(t)?(Object.defineProperty(_native2.default,t,{get:function(){return function(){for(var e=arguments.length,n=Array(e),i=0;i<e;i++)n[i]=arguments[i];return wx[t].apply(wx,n)}}}),e[t]=_native2.default[t]):(Object.defineProperty(_native2.default,t,{get:function(){return function(e){if(e=e||{},n.$interceptors[t]&&n.$interceptors[t].config){var i=n.$interceptors[t].config.call(n,e);if(!1===i)return n.$addons.promisify?Promise.reject("aborted by interceptor"):void(e.fail&&e.fail("aborted by interceptor"));e=i}if("request"===t&&(e="string"==typeof e?{url:e}:e),"string"==typeof e)return wx[t](e);if(n.$addons.promisify)return new Promise(function(i,r){var s={};["fail","success","complete"].forEach(function(o){s[o]=e[o],e[o]=function(e){n.$interceptors[t]&&n.$interceptors[t][o]&&(e=n.$interceptors[t][o].call(n,e)),"success"===o?i(e):"fail"===o&&r(e)}}),n.$addons.requestfix&&"request"===t?RequestMQ.request(e):wx[t](e)});var r={};["fail","success","complete"].forEach(function(i){r[i]=e[i],e[i]=function(e){n.$interceptors[t]&&n.$interceptors[t][i]&&(e=n.$interceptors[t][i].call(n,e)),r[i]&&r[i].call(n,e)}}),n.$addons.requestfix&&"request"===t?RequestMQ.request(e):wx[t](e)}}}),e[t]=_native2.default[t])})}}]),e}();exports.default=_class;